name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ "**" ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy

    - name: Check clang-format
      run: |
        echo "Checking code formatting..."
        find libs apps -name '*.cpp' -o -name '*.h' | xargs clang-format --dry-run --Werror
        if [ $? -ne 0 ]; then
          echo "❌ Code formatting check failed. Run 'clang-format -i' on the files above."
          exit 1
        fi
        echo "✅ Code formatting check passed"

    - name: Setup vcpkg (for clang-tidy)
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '8f54ef5453e7e76ff01e15988bf243e7247c5eb5'

    - name: Configure CMake (for compile_commands.json)
      run: |
        cmake -S . -B build \
          -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBUILD_TESTING=ON
      env:
        CC: clang
        CXX: clang++

    - name: Run clang-tidy
      run: |
        echo "Running clang-tidy static analysis..."
        find libs apps -name '*.cpp' | xargs clang-tidy -p build
        if [ $? -ne 0 ]; then
          echo "❌ clang-tidy found issues"
          exit 1
        fi
        echo "✅ clang-tidy check passed"
